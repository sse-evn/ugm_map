<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>E.O.M - Управление территорией</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <!-- Leaflet.Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #166534;
      --primary-light: #dcfce7;
      --primary-dark: #14532d;
    }
    
    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      overflow: hidden;
      background-color: #f7fee7;
    }
    
    #map {
      height: 100vh;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    
    .header {
      height: 60px;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }
    
    .logo {
      font-weight: 700;
      color: var(--primary);
      font-size: 1.2rem;
    }
    
    .user-badge {
      background-color: var(--primary-light);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 0.85rem;
      color: var(--primary-dark);
      border: 1px solid #bbf7d0;
    }
    
    .panel {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .panel-header {
      background-color: var(--primary);
      color: white;
      padding: 12px 16px;
      font-weight: 600;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
      border: 1px solid var(--primary-dark);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background-color: var(--primary-light);
    }
    
    .btn-danger {
      background-color: #dc2626;
      color: white;
      border: 1px solid #b91c1c;
    }
    
    .btn-danger:hover {
      background-color: #b91c1c;
    }
    
    .form-control {
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 8px 12px;
      width: 100%;
      transition: border-color 0.2s;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(22, 101, 52, 0.1);
    }
    
    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #374151;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .tab-button {
      padding: 10px 16px;
      border-bottom: 2px solid transparent;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
    }
    
    .tab-button.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th {
      text-align: left;
      padding: 12px 16px;
      background-color: #f3f4f6;
      color: #374151;
      font-weight: 600;
      font-size: 0.85rem;
    }
    
    .table td {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.9rem;
    }
    
    .table tr:hover {
      background-color: #f9fafb;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .badge-primary {
      background-color: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .badge-blue {
      background-color: #dbeafe;
      color: #1e40af;
    }
    
    .badge-yellow {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .badge-red {
      background-color: #fee2e2;
      color: #991b1b;
    }
    
    .leaflet-control-layers {
      border-radius: 8px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      border: none !important;
      overflow: hidden;
    }
    
    .leaflet-control-layers-toggle {
      width: 40px !important;
      height: 40px !important;
      background-image: none !important;
      background-color: white !important;
      border-radius: 8px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    
    .leaflet-control-layers-toggle:after {
      content: "≡";
      font-size: 1.2rem;
      color: var(--primary);
    }
    
    .leaflet-popup-content {
      margin: 12px !important;
      min-width: 200px;
    }
    
    .leaflet-popup-content h3 {
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 8px;
    }
    
    .leaflet-popup-content p {
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    
    .leaflet-popup-content .meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 8px;
    }
    
    .draw-toolbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 10;
      display: flex;
      gap: 8px;
    }
    
    .draw-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: white;
      border: 1px solid #d1d5db;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .draw-btn:hover {
      background: #f3f4f6;
    }
    
    .draw-btn.active {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
    }
  </style>
</head>
<body>
  <!-- Шапка приложения -->
  <header class="header fixed top-0 left-0 right-0 flex items-center justify-between px-4">
    <div class="logo flex items-center">
      <i class="fas fa-map-marked-alt mr-2"></i>
      <span>E.O.M</span>
    </div>
    
    <div class="flex items-center gap-4">
      <div id="userStatus" class="user-badge hidden">
        <i class="fas fa-user mr-1"></i>
        <span id="currentUser">Гость</span>
      </div>
      <button id="userLoginBtn" class="btn btn-outline">
        <i class="fas fa-sign-in-alt"></i>
        <span>Вход</span>
      </button>
    </div>
  </header>

  <!-- Основное содержимое -->
  <main class="relative pt-16 h-full">
    <!-- Карта -->
    <div id="map"></div>
    
    <!-- Панель инструментов рисования -->
    <div id="drawToolbar" class="draw-toolbar hidden">
      <button id="drawPolygon" class="draw-btn" title="Нарисовать полигон">
        <i class="fas fa-draw-polygon"></i>
      </button>
      <button id="drawRectangle" class="draw-btn" title="Нарисовать прямоугольник">
        <i class="fas fa-vector-square"></i>
      </button>
      <button id="drawMarker" class="draw-btn" title="Добавить маркер">
        <i class="fas fa-map-marker-alt"></i>
      </button>
      <button id="saveDrawing" class="draw-btn" title="Сохранить">
        <i class="fas fa-check"></i>
      </button>
      <button id="cancelDrawing" class="draw-btn" title="Отменить">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Панель управления картой -->
    <div id="mapControls" class="fixed top-20 left-4 z-10 bg-white rounded-lg shadow-lg p-3 w-64">
      <h3 class="font-semibold text-gray-700 mb-3 flex items-center justify-between">
        <span>Управление картой</span>
        <button id="closeMapControls" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </h3>
      
      <div class="space-y-3">
        <div>
          <label class="flex items-center justify-between cursor-pointer">
            <span class="text-sm font-medium text-gray-700">Рабочие зоны</span>
            <input type="checkbox" id="workLayerToggle" checked class="sr-only peer">
            <div class="relative w-11 h-6 bg-gray-200 rounded-full peer-checked:bg-green-600">
              <div class="absolute top-0.5 left-0.5 bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-5"></div>
            </div>
          </label>
        </div>
        
        <div>
          <label class="flex items-center justify-between cursor-pointer">
            <span class="text-sm font-medium text-gray-700">Зоны отдыха</span>
            <input type="checkbox" id="restLayerToggle" checked class="sr-only peer">
            <div class="relative w-11 h-6 bg-gray-200 rounded-full peer-checked:bg-green-600">
              <div class="absolute top-0.5 left-0.5 bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-5"></div>
            </div>
          </label>
        </div>
        
        <div>
          <label class="flex items-center justify-between cursor-pointer">
            <span class="text-sm font-medium text-gray-700">Контрольные точки</span>
            <input type="checkbox" id="checkpointLayerToggle" checked class="sr-only peer">
            <div class="relative w-11 h-6 bg-gray-200 rounded-full peer-checked:bg-green-600">
              <div class="absolute top-0.5 left-0.5 bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-5"></div>
            </div>
          </label>
        </div>
        
        <div>
          <label class="flex items-center justify-between cursor-pointer">
            <span class="text-sm font-medium text-gray-700">Скауты</span>
            <input type="checkbox" id="peopleLayerToggle" checked class="sr-only peer">
            <div class="relative w-11 h-6 bg-gray-200 rounded-full peer-checked:bg-green-600">
              <div class="absolute top-0.5 left-0.5 bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-5"></div>
            </div>
          </label>
        </div>
        
        <div class="pt-2 border-t">
          <button id="openAdminPanel" class="btn btn-primary w-full hidden">
            <i class="fas fa-cog"></i>
            <span>Панель администратора</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Кнопка открытия панели управления -->
    <button id="openMapControls" class="fixed top-20 left-4 z-10 bg-white p-3 rounded-lg shadow-lg">
      <i class="fas fa-layer-group text-green-600"></i>
    </button>
  </main>

  <!-- Модальное окно пользователя -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="panel-header flex justify-between items-center">
        <h3 id="userModalTitle">Личный кабинет</h3>
        <button id="closeUserModal" class="text-white hover:text-gray-200">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="p-4">
        <!-- Форма входа -->
        <div id="loginForm">
          <h4 class="font-semibold text-gray-800 mb-4">Вход в систему</h4>
          
          <div class="mb-4">
            <label class="form-label">Логин</label>
            <input id="loginInput" type="text" class="form-control" placeholder="Введите ваш логин">
          </div>
          
          <div class="mb-4">
            <label class="form-label">Пароль</label>
            <input id="passwordInput" type="password" class="form-control" placeholder="Введите пароль">
          </div>
          
          <button id="submitLogin" class="btn btn-primary w-full mb-3">
            <i class="fas fa-sign-in-alt"></i>
            <span>Войти</span>
          </button>
          
          <div class="text-center text-sm text-gray-600">
            Нет аккаунта? <button id="showRegisterForm" class="text-green-600 hover:underline">Зарегистрироваться</button>
          </div>
        </div>
        
        <!-- Форма регистрации -->
        <div id="registerForm" class="hidden">
          <h4 class="font-semibold text-gray-800 mb-4">Регистрация</h4>
          
          <div class="mb-4">
            <label class="form-label">ФИО</label>
            <input id="registerName" type="text" class="form-control" placeholder="Иванов Иван Иванович">
          </div>
          
          <div class="mb-4">
            <label class="form-label">Логин</label>
            <input id="registerLogin" type="text" class="form-control" placeholder="Придумайте логин">
          </div>
          
          <div class="mb-4">
            <label class="form-label">Пароль</label>
            <input id="registerPassword" type="password" class="form-control" placeholder="Придумайте пароль">
          </div>
          
          <button id="submitRegister" class="btn btn-primary w-full mb-3">
            <i class="fas fa-user-plus"></i>
            <span>Зарегистрироваться</span>
          </button>
          
          <div class="text-center text-sm text-gray-600">
            Уже есть аккаунт? <button id="showLoginForm" class="text-green-600 hover:underline">Войти</button>
          </div>
        </div>
        
        <!-- Информация о пользователе -->
        <div id="userInfo" class="hidden">
          <div class="flex items-center mb-6">
            <div class="bg-green-100 p-3 rounded-full mr-4">
              <i class="fas fa-user text-green-600 text-xl"></i>
            </div>
            <div>
              <h4 id="userFullName" class="font-bold text-lg">Иванов Иван Иванович</h4>
              <span id="userPosition" class="badge badge-primary mt-1">Скаут</span>
            </div>
          </div>
          
          <div class="space-y-3 mb-6">
            <div class="flex items-center text-gray-700">
              <i class="fas fa-user-circle w-6 text-gray-500"></i>
              <span id="userLoginInfo">Логин: scout1</span>
            </div>
            <div class="flex items-center text-gray-700">
              <i class="fas fa-clock w-6 text-gray-500"></i>
              <span id="userLastLogin">Последний вход: 12.05.2023 14:30</span>
            </div>
          </div>
          
          <div class="space-y-2">
            <button id="userTasksBtn" class="btn btn-outline w-full text-left">
              <i class="fas fa-tasks"></i>
              <span>Мои задания</span>
            </button>
            
            <button id="userLogout" class="btn btn-danger w-full mt-4">
              <i class="fas fa-sign-out-alt"></i>
              <span>Выйти</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно администратора -->
  <div id="adminModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="panel-header flex justify-between items-center">
        <h3>Панель администратора</h3>
        <button id="closeAdminModal" class="text-white hover:text-gray-200">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="p-4">
        <!-- Навигация -->
        <div class="flex border-b mb-4">
          <button id="adminZonesTab" class="tab-button active">Зоны</button>
          <button id="adminUsersTab" class="tab-button">Пользователи</button>
          <button id="adminTasksTab" class="tab-button">Задания</button>
        </div>
        
        <!-- Управление зонами -->
        <div id="adminZonesSection">
          <div class="panel mb-6">
            <div class="panel-header">Добавить/редактировать зону</div>
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="form-label">Тип зоны</label>
                  <select id="zoneType" class="form-control">
                    <option value="work">Рабочая зона</option>
                    <option value="rest">Зона отдыха</option>
                    <option value="checkpoint">Контрольная точка</option>
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Название зоны</label>
                  <input id="zoneName" type="text" class="form-control" placeholder="Введите название">
                </div>
              </div>
              
              <div class="mb-4">
                <label class="form-label">Описание</label>
                <textarea id="zoneDescription" rows="2" class="form-control" placeholder="Дополнительная информация"></textarea>
              </div>
              
              <div class="mb-4">
                <label class="form-label">Координаты</label>
                <textarea id="zoneCoords" rows="3" class="form-control" placeholder="Нарисуйте зону на карте или введите координаты вручную"></textarea>
              </div>
              
              <div class="flex gap-2">
                <button id="addZoneBtn" class="btn btn-primary flex-1">
                  <i class="fas fa-plus"></i>
                  <span>Добавить</span>
                </button>
                
                <button id="updateZoneBtn" class="btn btn-primary flex-1 hidden">
                  <i class="fas fa-save"></i>
                  <span>Сохранить</span>
                </button>
                
                <button id="cancelZoneEditBtn" class="btn btn-outline hidden">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div class="panel">
            <div class="panel-header">Список зон</div>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>Название</th>
                    <th>Тип</th>
                    <th>Действия</th>
                  </tr>
                </thead>
                <tbody id="zonesList">
                  <!-- Зоны будут здесь -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Управление пользователями -->
        <div id="adminUsersSection" class="hidden">
          <div class="panel mb-6">
            <div class="panel-header">Добавить/редактировать пользователя</div>
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="form-label">ФИО</label>
                  <input id="userName" type="text" class="form-control" placeholder="Иванов Иван Иванович">
                </div>
                
                <div>
                  <label class="form-label">Логин</label>
                  <input id="userLogin" type="text" class="form-control" placeholder="Придумайте логин">
                </div>
                
                <div>
                  <label class="form-label">Пароль</label>
                  <input id="userPassword" type="password" class="form-control" placeholder="Придумайте пароль">
                </div>
                
                <div>
                  <label class="form-label">Должность</label>
                  <select id="userPosition" class="form-control">
                    <option value="scout">Скаут</option>
                    <option value="manager">Менеджер</option>
                    <option value="admin">Администратор</option>
                  </select>
                </div>
              </div>
              
              <div class="flex gap-2">
                <button id="addUserBtn" class="btn btn-primary flex-1">
                  <i class="fas fa-user-plus"></i>
                  <span>Добавить</span>
                </button>
                
                <button id="updateUserBtn" class="btn btn-primary flex-1 hidden">
                  <i class="fas fa-save"></i>
                  <span>Сохранить</span>
                </button>
                
                <button id="cancelUserEditBtn" class="btn btn-outline hidden">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div class="panel">
            <div class="panel-header">Список пользователей</div>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>ФИО</th>
                    <th>Логин</th>
                    <th>Должность</th>
                    <th>Действия</th>
                  </tr>
                </thead>
                <tbody id="usersList">
                  <!-- Пользователи будут здесь -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Управление заданиями -->
        <div id="adminTasksSection" class="hidden">
          <div class="panel mb-6">
            <div class="panel-header">Создать задание</div>
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="form-label">Название задания</label>
                  <input id="taskName" type="text" class="form-control" placeholder="Например: Убрать самокаты">
                </div>
                
                <div>
                  <label class="form-label">Тип задания</label>
                  <select id="taskType" class="form-control">
                    <option value="cleaning">Уборка территории</option>
                    <option value="inspection">Проверка порядка</option>
                    <option value="patrol">Патрулирование</option>
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Исполнитель</label>
                  <select id="taskAssignee" class="form-control">
                    <!-- Пользователи будут здесь -->
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Срок выполнения</label>
                  <input id="taskDueDate" type="datetime-local" class="form-control">
                </div>
              </div>
              
              <div class="mb-4">
                <label class="form-label">Описание</label>
                <textarea id="taskDescription" rows="3" class="form-control" placeholder="Подробное описание задания"></textarea>
              </div>
              
              <div class="mb-4">
                <label class="form-label">Зона выполнения</label>
                <select id="taskZone" class="form-control">
                  <!-- Зоны будут здесь -->
                </select>
              </div>
              
              <div class="flex gap-2">
                <button id="addTaskBtn" class="btn btn-primary flex-1">
                  <i class="fas fa-plus"></i>
                  <span>Создать</span>
                </button>
                
                <button id="updateTaskBtn" class="btn btn-primary flex-1 hidden">
                  <i class="fas fa-save"></i>
                  <span>Сохранить</span>
                </button>
                
                <button id="cancelTaskEditBtn" class="btn btn-outline hidden">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div class="panel">
            <div class="panel-header">Список заданий</div>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>Название</th>
                    <th>Исполнитель</th>
                    <th>Статус</th>
                    <th>Срок</th>
                    <th>Действия</th>
                  </tr>
                </thead>
                <tbody id="tasksList">
                  <!-- Задания будут здесь -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- Leaflet.Draw JS -->
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <!-- Font Awesome JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  
  <script>
    // Инициализация карты (центр Алматы)
    const map = L.map('map', {
      zoomControl: true,
      doubleClickZoom: false,
      maxZoom: 18,
      minZoom: 10
    }).setView([43.2389, 76.8897], 12);

    // Добавление тайлов OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18
    }).addTo(map);

    // Слои для зон
    const workLayer = L.layerGroup().addTo(map);
    const restLayer = L.layerGroup().addTo(map);
    const checkpointLayer = L.layerGroup().addTo(map);
    const peopleLayer = L.layerGroup().addTo(map);
    const tasksLayer = L.layerGroup().addTo(map);
    const drawnItems = new L.FeatureGroup().addTo(map);

    // Иконки для пользователей
    const userIcons = {
      scout: L.divIcon({ 
        className: 'fas fa-user bg-blue-500 text-white p-1 rounded-full',
        iconSize: [24, 24]
      }),
      manager: L.divIcon({ 
        className: 'fas fa-user-tie bg-green-600 text-white p-1 rounded-full',
        iconSize: [24, 24]
      }),
      admin: L.divIcon({ 
        className: 'fas fa-user-shield bg-purple-600 text-white p-1 rounded-full',
        iconSize: [24, 24]
      })
    };

    // Иконки для заданий
    const taskIcons = {
      cleaning: L.divIcon({ 
        className: 'fas fa-broom bg-orange-500 text-white p-1 rounded-full',
        iconSize: [24, 24]
      }),
      inspection: L.divIcon({ 
        className: 'fas fa-clipboard-check bg-blue-500 text-white p-1 rounded-full',
        iconSize: [24, 24]
      }),
      patrol: L.divIcon({ 
        className: 'fas fa-walking bg-green-500 text-white p-1 rounded-full',
        iconSize: [24, 24]
      })
    };

    // Данные приложения
    let appData = JSON.parse(localStorage.getItem('eomData')) || {
      users: [
        { 
          id: 'u1', 
          name: 'Администратор', 
          login: 'admin', 
          password: 'admin', 
          position: 'admin', 
          lastLogin: new Date().toISOString() 
        },
        { 
          id: 'u2', 
          name: 'Менеджер', 
          login: 'manager', 
          password: 'manager', 
          position: 'manager', 
          lastLogin: new Date().toISOString() 
        },
        { 
          id: 'u3', 
          name: 'Скаут', 
          login: 'scout', 
          password: 'scout', 
          position: 'scout', 
          lastLogin: new Date().toISOString() 
        }
      ],
      zones: {
        work: [
          { 
            id: 'w1', 
            coords: [[43.25, 76.85], [43.25, 76.90], [43.30, 76.90], [43.30, 76.85]], 
            name: 'Центральный район', 
            description: 'Основная рабочая зона' 
          }
        ],
        rest: [
          { 
            id: 'r1', 
            coords: [[43.23, 76.88], [43.23, 76.93], [43.28, 76.93], [43.28, 76.88]], 
            name: 'Центральный парк', 
            description: 'Место для отдыха' 
          }
        ],
        checkpoint: [
          { 
            id: 'c1', 
            coords: [43.24, 76.91], 
            name: 'Контрольная точка 1', 
            description: 'Основной контрольный пункт' 
          }
        ]
      },
      tasks: [
        { 
          id: 't1', 
          name: 'Убрать самокаты', 
          type: 'cleaning', 
          assignee: 'u3', 
          dueDate: new Date(Date.now() + 86400000).toISOString(), 
          description: 'Убрать все самокаты в парковой зоне', 
          zone: 'r1',
          status: 'pending' 
        }
      ],
      peopleLocations: {
        u1: [43.238, 76.89],
        u2: [43.24, 76.88],
        u3: [43.245, 76.895]
      }
    };

    // Текущий пользователь
    let currentUser = null;
    let currentDrawing = null;
    let currentDrawControl = null;

    // Функция для отображения зон на карте
    function renderZones() {
      // Очищаем все слои
      workLayer.clearLayers();
      restLayer.clearLayers();
      checkpointLayer.clearLayers();
      peopleLayer.clearLayers();
      tasksLayer.clearLayers();

      // Рабочие зоны
      appData.zones.work.forEach(zone => {
        const polygon = L.polygon(zone.coords, { 
          color: '#2563eb', 
          fillColor: '#3b82f6', 
          fillOpacity: 0.3,
          weight: 2
        }).addTo(workLayer);
        
        polygon.bindPopup(`
          <h3>${zone.name}</h3>
          <p>${zone.description || 'Нет описания'}</p>
          <p class="meta">Тип: Рабочая зона</p>
        `);
      });

      // Зоны отдыха
      appData.zones.rest.forEach(zone => {
        const polygon = L.polygon(zone.coords, { 
          color: '#16a34a', 
          fillColor: '#22c55e', 
          fillOpacity: 0.3,
          weight: 2
        }).addTo(restLayer);
        
        polygon.bindPopup(`
          <h3>${zone.name}</h3>
          <p>${zone.description || 'Нет описания'}</p>
          <p class="meta">Тип: Зона отдыха</p>
        `);
      });

      // Контрольные точки
      appData.zones.checkpoint.forEach(zone => {
        const marker = L.marker(zone.coords, {
          icon: L.divIcon({ 
            className: 'fas fa-flag bg-red-500 text-white p-1 rounded-full',
            iconSize: [24, 24]
          })
        }).addTo(checkpointLayer);
        
        marker.bindPopup(`
          <h3>${zone.name}</h3>
          <p>${zone.description || 'Нет описания'}</p>
          <p class="meta">Тип: Контрольная точка</p>
        `);
      });

      // Пользователи
      Object.entries(appData.peopleLocations).forEach(([userId, coords]) => {
        const user = appData.users.find(u => u.id === userId);
        if (user) {
          const marker = L.marker(coords, {
            icon: userIcons[user.position]
          }).addTo(peopleLayer);
          
          marker.bindPopup(`
            <h3>${user.name}</h3>
            <p>Должность: ${getPositionName(user.position)}</p>
            <p class="meta">Логин: ${user.login}</p>
          `);
        }
      });

      // Задания
      appData.tasks.forEach(task => {
        const zone = [...appData.zones.work, ...appData.zones.rest].find(z => z.id === task.zone);
        if (zone) {
          const center = getPolygonCenter(zone.coords);
          const marker = L.marker(center, {
            icon: taskIcons[task.type]
          }).addTo(tasksLayer);
          
          const assignee = appData.users.find(u => u.id === task.assignee);
          const assigneeName = assignee ? assignee.name : 'Не назначен';
          
          marker.bindPopup(`
            <h3>${task.name}</h3>
            <p>${task.description || 'Нет описания'}</p>
            <p>Исполнитель: ${assigneeName}</p>
            <p>Срок: ${new Date(task.dueDate).toLocaleString()}</p>
            <p class="meta">Статус: ${getTaskStatusName(task.status)}</p>
          `);
        }
      });
    }

    // Получение центра полигона
    function getPolygonCenter(coords) {
      if (coords[0] && !Array.isArray(coords[0][0])) {
        // Это точка
        return coords;
      }
      
      // Это полигон
      let latSum = 0;
      let lngSum = 0;
      let count = 0;
      
      coords[0].forEach(point => {
        latSum += point[0];
        lngSum += point[1];
        count++;
      });
      
      return [latSum / count, lngSum / count];
    }

    // Получение названия должности
    function getPositionName(position) {
      const positions = {
        scout: 'Скаут',
        manager: 'Менеджер',
        admin: 'Администратор'
      };
      return positions[position] || position;
    }

    // Получение названия статуса задания
    function getTaskStatusName(status) {
      const statuses = {
        pending: 'В ожидании',
        in_progress: 'В работе',
        completed: 'Завершено',
        cancelled: 'Отменено'
      };
      return statuses[status] || status;
    }

    // Получение класса для статуса задания
    function getTaskStatusClass(status) {
      const classes = {
        pending: 'badge-yellow',
        in_progress: 'badge-blue',
        completed: 'badge-primary',
        cancelled: 'badge-red'
      };
      return classes[status] || 'badge';
    }

    // Получение названия типа зоны
    function getZoneTypeName(type) {
      const types = {
        work: 'Рабочая зона',
        rest: 'Зона отдыха',
        checkpoint: 'Контрольная точка'
      };
      return types[type] || type;
    }

    // Получение названия типа задания
    function getTaskTypeName(type) {
      const types = {
        cleaning: 'Уборка',
        inspection: 'Проверка',
        patrol: 'Патрулирование'
      };
      return types[type] || type;
    }

    // Сохранение данных в localStorage
    function saveData() {
      localStorage.setItem('eomData', JSON.stringify(appData));
      if (currentUser) {
        localStorage.setItem('currentUser', JSON.stringify({
          id: currentUser.id,
          login: currentUser.login
        }));
      }
    }

    // Обновление списка зон в админ-панели
    function updateZonesList() {
      const zonesList = document.getElementById('zonesList');
      zonesList.innerHTML = '';
      
      Object.entries(appData.zones).forEach(([type, zones]) => {
        zones.forEach(zone => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${zone.name}</td>
            <td>${getZoneTypeName(type)}</td>
            <td>
              <button class="edit-zone text-blue-600 hover:text-blue-800 mr-2" data-id="${zone.id}" data-type="${type}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="delete-zone text-red-600 hover:text-red-800" data-id="${zone.id}" data-type="${type}">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          zonesList.appendChild(tr);
        });
      });

      // Обновляем список зон в форме создания задания
      const taskZoneSelect = document.getElementById('taskZone');
      taskZoneSelect.innerHTML = '';
      
      [...appData.zones.work, ...appData.zones.rest].forEach(zone => {
        const option = document.createElement('option');
        option.value = zone.id;
        option.textContent = `${zone.name} (${getZoneTypeName(zone.type)})`;
        taskZoneSelect.appendChild(option);
      });

      // Обработчики для кнопок редактирования и удаления
      document.querySelectorAll('.edit-zone').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const type = btn.dataset.type;
          const zone = appData.zones[type].find(z => z.id === id);
          
          document.getElementById('zoneType').value = type;
          document.getElementById('zoneName').value = zone.name;
          document.getElementById('zoneDescription').value = zone.description || '';
          document.getElementById('zoneCoords').value = JSON.stringify(zone.coords);
          
          // Переключаем в режим редактирования
          document.getElementById('addZoneBtn').classList.add('hidden');
          document.getElementById('updateZoneBtn').classList.remove('hidden');
          document.getElementById('cancelZoneEditBtn').classList.remove('hidden');
          
          document.getElementById('updateZoneBtn').dataset.editId = id;
          document.getElementById('updateZoneBtn').dataset.editType = type;
        });
      });

      document.querySelectorAll('.delete-zone').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Вы уверены, что хотите удалить эту зону?')) {
            const id = btn.dataset.id;
            const type = btn.dataset.type;
            appData.zones[type] = appData.zones[type].filter(z => z.id !== id);
            saveData();
            renderZones();
            updateZonesList();
            updateTasksList();
          }
        });
      });
    }

    // Выход из режима редактирования зоны
    function cancelZoneEdit() {
      document.getElementById('zoneName').value = '';
      document.getElementById('zoneDescription').value = '';
      document.getElementById('zoneCoords').value = '';
      
      document.getElementById('addZoneBtn').classList.remove('hidden');
      document.getElementById('updateZoneBtn').classList.add('hidden');
      document.getElementById('cancelZoneEditBtn').classList.add('hidden');
      
      delete document.getElementById('updateZoneBtn').dataset.editId;
      delete document.getElementById('updateZoneBtn').dataset.editType;
      
      // Очищаем рисунок на карте
      if (currentDrawing) {
        map.removeLayer(currentDrawing);
        currentDrawing = null;
      }
      hideDrawToolbar();
    }

    // Обновление списка пользователей в админ-панели
    function updateUsersList() {
      const usersList = document.getElementById('usersList');
      usersList.innerHTML = '';
      
      // Обновляем список в форме создания задания
      const taskAssigneeSelect = document.getElementById('taskAssignee');
      taskAssigneeSelect.innerHTML = '<option value="">Не назначен</option>';
      
      appData.users.forEach(user => {
        // Добавляем в таблицу пользователей
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.name}</td>
          <td>${user.login}</td>
          <td>${getPositionName(user.position)}</td>
          <td>
            <button class="edit-user text-blue-600 hover:text-blue-800 mr-2" data-id="${user.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-user text-red-600 hover:text-red-800" data-id="${user.id}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        usersList.appendChild(tr);
        
        // Добавляем в выпадающий список для заданий (только скаутов)
        if (user.position === 'scout') {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.name}`;
          taskAssigneeSelect.appendChild(option);
        }
      });

      // Обработчики для кнопок редактирования и удаления пользователей
      document.querySelectorAll('.edit-user').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const user = appData.users.find(u => u.id === id);
          
          document.getElementById('userName').value = user.name;
          document.getElementById('userLogin').value = user.login;
          document.getElementById('userPassword').value = '';
          document.getElementById('userPosition').value = user.position;
          
          // Переключаем в режим редактирования
          document.getElementById('addUserBtn').classList.add('hidden');
          document.getElementById('updateUserBtn').classList.remove('hidden');
          document.getElementById('cancelUserEditBtn').classList.remove('hidden');
          
          document.getElementById('updateUserBtn').dataset.editId = id;
        });
      });

      document.querySelectorAll('.delete-user').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            const id = btn.dataset.id;
            
            // Нельзя удалить текущего пользователя
            if (currentUser && currentUser.id === id) {
              alert('Нельзя удалить текущего пользователя');
              return;
            }
            
            appData.users = appData.users.filter(u => u.id !== id);
            
            // Удаляем местоположение пользователя, если оно есть
            if (appData.peopleLocations[id]) {
              delete appData.peopleLocations[id];
            }
            
            // Удаляем пользователя из заданий
            appData.tasks.forEach(task => {
              if (task.assignee === id) {
                task.assignee = '';
              }
            });
            
            saveData();
            updateUsersList();
            updateTasksList();
            renderZones();
          }
        });
      });
    }

    // Выход из режима редактирования пользователя
    function cancelUserEdit() {
      document.getElementById('userName').value = '';
      document.getElementById('userLogin').value = '';
      document.getElementById('userPassword').value = '';
      document.getElementById('userPosition').value = 'scout';
      
      document.getElementById('addUserBtn').classList.remove('hidden');
      document.getElementById('updateUserBtn').classList.add('hidden');
      document.getElementById('cancelUserEditBtn').classList.add('hidden');
      
      delete document.getElementById('updateUserBtn').dataset.editId;
    }

    // Обновление списка заданий
    function updateTasksList() {
      const tasksList = document.getElementById('tasksList');
      tasksList.innerHTML = '';
      
      appData.tasks.forEach(task => {
        const assignee = appData.users.find(u => u.id === task.assignee);
        const assigneeName = assignee ? assignee.name : 'Не назначен';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${task.name}</td>
          <td>${assigneeName}</td>
          <td><span class="${getTaskStatusClass(task.status)}">${getTaskStatusName(task.status)}</span></td>
          <td>${new Date(task.dueDate).toLocaleDateString()}</td>
          <td>
            <button class="edit-task text-blue-600 hover:text-blue-800 mr-2" data-id="${task.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-task text-red-600 hover:text-red-800" data-id="${task.id}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tasksList.appendChild(tr);
      });

      // Обработчики для кнопок редактирования и удаления заданий
      document.querySelectorAll('.edit-task').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const task = appData.tasks.find(t => t.id === id);
          
          document.getElementById('taskName').value = task.name;
          document.getElementById('taskType').value = task.type;
          document.getElementById('taskAssignee').value = task.assignee;
          document.getElementById('taskDueDate').value = new Date(task.dueDate).toISOString().slice(0, 16);
          document.getElementById('taskDescription').value = task.description || '';
          document.getElementById('taskZone').value = task.zone;
          
          // Переключаем в режим редактирования
          document.getElementById('addTaskBtn').classList.add('hidden');
          document.getElementById('updateTaskBtn').classList.remove('hidden');
          document.getElementById('cancelTaskEditBtn').classList.remove('hidden');
          
          document.getElementById('updateTaskBtn').dataset.editId = id;
        });
      });

      document.querySelectorAll('.delete-task').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Вы уверены, что хотите удалить это задание?')) {
            const id = btn.dataset.id;
            appData.tasks = appData.tasks.filter(t => t.id !== id);
            saveData();
            updateTasksList();
            renderZones();
          }
        });
      });
    }

    // Выход из режима редактирования задания
    function cancelTaskEdit() {
      document.getElementById('taskName').value = '';
      document.getElementById('taskType').value = 'cleaning';
      document.getElementById('taskAssignee').value = '';
      document.getElementById('taskDueDate').value = '';
      document.getElementById('taskDescription').value = '';
      document.getElementById('taskZone').value = '';
      
      document.getElementById('addTaskBtn').classList.remove('hidden');
      document.getElementById('updateTaskBtn').classList.add('hidden');
      document.getElementById('cancelTaskEditBtn').classList.add('hidden');
      
      delete document.getElementById('updateTaskBtn').dataset.editId;
    }

    // Показать панель рисования
    function showDrawToolbar() {
      document.getElementById('drawToolbar').classList.remove('hidden');
    }

    // Скрыть панель рисования
    function hideDrawToolbar() {
      document.getElementById('drawToolbar').classList.add('hidden');
    }

    // Начать рисование полигона
    function startDrawingPolygon() {
      if (currentDrawing) {
        map.removeLayer(currentDrawing);
      }
      
      currentDrawing = new L.Draw.Polygon(map, {
        shapeOptions: {
          color: '#3b82f6',
          fillColor: '#3b82f6',
          fillOpacity: 0.3
        }
      });
      
      currentDrawing.enable();
      showDrawToolbar();
    }

    // Начать рисование прямоугольника
    function startDrawingRectangle() {
      if (currentDrawing) {
        map.removeLayer(currentDrawing);
      }
      
      currentDrawing = new L.Draw.Rectangle(map, {
        shapeOptions: {
          color: '#3b82f6',
          fillColor: '#3b82f6',
          fillOpacity: 0.3
        }
      });
      
      currentDrawing.enable();
      showDrawToolbar();
    }

    // Начать добавление маркера
    function startDrawingMarker() {
      if (currentDrawing) {
        map.removeLayer(currentDrawing);
      }
      
      currentDrawing = new L.Draw.Marker(map, {
        icon: new L.Icon.Default()
      });
      
      currentDrawing.enable();
      showDrawToolbar();
    }

    // Сохранить рисунок
    function saveDrawing() {
      if (currentDrawing && currentDrawing._layer) {
        const layer = currentDrawing._layer;
        let coords;
        
        if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
          coords = layer.getLatLngs()[0].map(latLng => [latLng.lat, latLng.lng]);
        } else if (layer instanceof L.Marker) {
          coords = [layer.getLatLng().lat, layer.getLatLng().lng];
        }
        
        if (coords) {
          document.getElementById('zoneCoords').value = JSON.stringify(coords);
          hideDrawToolbar();
          
          // Очищаем рисунок
          map.removeLayer(layer);
          currentDrawing = null;
        }
      }
    }

    // Отменить рисование
    function cancelDrawing() {
      if (currentDrawing && currentDrawing._layer) {
        map.removeLayer(currentDrawing._layer);
      }
      currentDrawing = null;
      hideDrawToolbar();
    }

    // Управление видимостью слоев
    document.getElementById('workLayerToggle').addEventListener('change', (e) => {
      if (e.target.checked) {
        map.addLayer(workLayer);
      } else {
        map.removeLayer(workLayer);
      }
    });

    document.getElementById('restLayerToggle').addEventListener('change', (e) => {
      if (e.target.checked) {
        map.addLayer(restLayer);
      } else {
        map.removeLayer(restLayer);
      }
    });

    document.getElementById('checkpointLayerToggle').addEventListener('change', (e) => {
      if (e.target.checked) {
        map.addLayer(checkpointLayer);
      } else {
        map.removeLayer(checkpointLayer);
      }
    });

    document.getElementById('peopleLayerToggle').addEventListener('change', (e) => {
      if (e.target.checked) {
        map.addLayer(peopleLayer);
      } else {
        map.removeLayer(peopleLayer);
      }
    });

    // Управление модальными окнами
    const userModal = document.getElementById('userModal');
    const adminModal = document.getElementById('adminModal');
    const mapControls = document.getElementById('mapControls');

    function openUserModal() {
      if (currentUser) {
        showUserInfo();
      } else {
        showLoginForm();
      }
      userModal.classList.add('active');
    }

    function closeUserModal() {
      userModal.classList.remove('active');
    }

    function openAdminModal() {
      if (!currentUser) {
        openUserModal();
        return;
      }
      
      if (currentUser.position !== 'admin') {
        alert('Только администратор может открыть эту панель');
        return;
      }
      
      adminModal.classList.add('active');
      updateZonesList();
      updateUsersList();
      updateTasksList();
    }

    function closeAdminModal() {
      adminModal.classList.remove('active');
      cancelZoneEdit();
      cancelUserEdit();
      cancelTaskEdit();
    }

    function toggleMapControls() {
      mapControls.classList.toggle('hidden');
    }

    // Показываем форму входа
    function showLoginForm() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('userInfo').classList.add('hidden');
      document.getElementById('userModalTitle').textContent = 'Вход в систему';
    }

    // Показываем форму регистрации
    function showRegisterForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('userInfo').classList.add('hidden');
      document.getElementById('userModalTitle').textContent = 'Регистрация';
    }

    // Показываем информацию о пользователе
    function showUserInfo() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('userModalTitle').textContent = 'Личный кабинет';
      
      document.getElementById('userFullName').textContent = currentUser.name;
      document.getElementById('userPosition').textContent = getPositionName(currentUser.position);
      document.getElementById('userLoginInfo').textContent = `Логин: ${currentUser.login}`;
      document.getElementById('userLastLogin').textContent = `Последний вход: ${new Date(currentUser.lastLogin).toLocaleString()}`;
    }

    // Обработчики событий
    document.getElementById('userLoginBtn').addEventListener('click', openUserModal);
    document.getElementById('closeUserModal').addEventListener('click', closeUserModal);
    document.getElementById('showRegisterForm').addEventListener('click', showRegisterForm);
    document.getElementById('showLoginForm').addEventListener('click', showLoginForm);
    document.getElementById('openAdminPanel').addEventListener('click', openAdminModal);
    document.getElementById('closeAdminModal').addEventListener('click', closeAdminModal);
    document.getElementById('openMapControls').addEventListener('click', toggleMapControls);
    document.getElementById('closeMapControls').addEventListener('click', toggleMapControls);

    // Навигация в админ-панели
    document.getElementById('adminZonesTab').addEventListener('click', () => {
      document.getElementById('adminZonesTab').classList.add('active');
      document.getElementById('adminUsersTab').classList.remove('active');
      document.getElementById('adminTasksTab').classList.remove('active');
      
      document.getElementById('adminZonesSection').classList.remove('hidden');
      document.getElementById('adminUsersSection').classList.add('hidden');
      document.getElementById('adminTasksSection').classList.add('hidden');
    });

    document.getElementById('adminUsersTab').addEventListener('click', () => {
      document.getElementById('adminUsersTab').classList.add('active');
      document.getElementById('adminZonesTab').classList.remove('active');
      document.getElementById('adminTasksTab').classList.remove('active');
      
      document.getElementById('adminUsersSection').classList.remove('hidden');
      document.getElementById('adminZonesSection').classList.add('hidden');
      document.getElementById('adminTasksSection').classList.add('hidden');
    });

    document.getElementById('adminTasksTab').addEventListener('click', () => {
      document.getElementById('adminTasksTab').classList.add('active');
      document.getElementById('adminZonesTab').classList.remove('active');
      document.getElementById('adminUsersTab').classList.remove('active');
      
      document.getElementById('adminTasksSection').classList.remove('hidden');
      document.getElementById('adminZonesSection').classList.add('hidden');
      document.getElementById('adminUsersSection').classList.add('hidden');
    });

    // Инструменты рисования
    document.getElementById('drawPolygon').addEventListener('click', startDrawingPolygon);
    document.getElementById('drawRectangle').addEventListener('click', startDrawingRectangle);
    document.getElementById('drawMarker').addEventListener('click', startDrawingMarker);
    document.getElementById('saveDrawing').addEventListener('click', saveDrawing);
    document.getElementById('cancelDrawing').addEventListener('click', cancelDrawing);

    // Обработка созданных объектов
    map.on(L.Draw.Event.CREATED, (e) => {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      currentDrawing = e;
    });

    // Вход пользователя
    document.getElementById('submitLogin').addEventListener('click', () => {
      const login = document.getElementById('loginInput').value;
      const password = document.getElementById('passwordInput').value;
      
      const user = appData.users.find(u => u.login === login && u.password === password);
      if (user) {
        currentUser = user;
        user.lastLogin = new Date().toISOString();
        saveData();
        
        // Обновляем интерфейс
        document.getElementById('userStatus').classList.remove('hidden');
        document.getElementById('currentUser').textContent = user.name;
        document.getElementById('userLoginBtn').innerHTML = `
          <i class="fas fa-user"></i>
          <span>Профиль</span>
        `;
        
        // Показываем кнопку админ-панели для администраторов
        if (user.position === 'admin') {
          document.getElementById('openAdminPanel').classList.remove('hidden');
        } else {
          document.getElementById('openAdminPanel').classList.add('hidden');
        }
        
        showUserInfo();
      } else {
        alert('Неверный логин или пароль');
      }
    });

    // Регистрация пользователя
    document.getElementById('submitRegister').addEventListener('click', () => {
      const name = document.getElementById('registerName').value;
      const login = document.getElementById('registerLogin').value;
      const password = document.getElementById('registerPassword').value;
      
      if (!name || !login || !password) {
        alert('Заполните все обязательные поля');
        return;
      }
      
      if (appData.users.some(u => u.login === login)) {
        alert('Пользователь с таким логином уже существует');
        return;
      }
      
      const newUser = {
        id: `u${Date.now()}`,
        name,
        login,
        password,
        position: 'scout',
        lastLogin: new Date().toISOString()
      };
      
      appData.users.push(newUser);
      saveData();
      
      // Автоматически входим под новым пользователем
      currentUser = newUser;
      document.getElementById('userStatus').classList.remove('hidden');
      document.getElementById('currentUser').textContent = name;
      document.getElementById('userLoginBtn').innerHTML = `
        <i class="fas fa-user"></i>
        <span>Профиль</span>
      `;
      
      showUserInfo();
    });

    // Выход пользователя
    document.getElementById('userLogout').addEventListener('click', () => {
      currentUser = null;
      localStorage.removeItem('currentUser');
      
      document.getElementById('userStatus').classList.add('hidden');
      document.getElementById('userLoginBtn').innerHTML = `
        <i class="fas fa-sign-in-alt"></i>
        <span>Вход</span>
      `;
      
      document.getElementById('openAdminPanel').classList.add('hidden');
      showLoginForm();
    });

    // Управление зонами
    document.getElementById('addZoneBtn').addEventListener('click', () => {
      const type = document.getElementById('zoneType').value;
      const name = document.getElementById('zoneName').value;
      const description = document.getElementById('zoneDescription').value;
      let coords;
      
      try {
        coords = JSON.parse(document.getElementById('zoneCoords').value || '[]');
      } catch (e) {
        alert('Неверный формат координат (используйте JSON)');
        return;
      }
      
      if (name && coords.length) {
        const id = `${type}_${Date.now()}`;
        appData.zones[type].push({ 
          id, 
          coords, 
          name,
          description
        });
        
        saveData();
        renderZones();
        updateZonesList();
        
        document.getElementById('zoneName').value = '';
        document.getElementById('zoneDescription').value = '';
        document.getElementById('zoneCoords').value = '';
      } else {
        alert('Заполните название и координаты');
      }
    });

    document.getElementById('updateZoneBtn').addEventListener('click', () => {
      const id = document.getElementById('updateZoneBtn').dataset.editId;
      const oldType = document.getElementById('updateZoneBtn').dataset.editType;
      const type = document.getElementById('zoneType').value;
      const name = document.getElementById('zoneName').value;
      const description = document.getElementById('zoneDescription').value;
      let coords;
      
      try {
        coords = JSON.parse(document.getElementById('zoneCoords').value || '[]');
      } catch (e) {
        alert('Неверный формат координат (используйте JSON)');
        return;
      }
      
      if (name && coords.length) {
        // Удаляем старую зону
        appData.zones[oldType] = appData.zones[oldType].filter(z => z.id !== id);
        
        // Добавляем обновленную
        appData.zones[type].push({ 
          id, 
          coords, 
          name,
          description
        });
        
        saveData();
        renderZones();
        updateZonesList();
        cancelZoneEdit();
      } else {
        alert('Заполните название и координаты');
      }
    });

    document.getElementById('cancelZoneEditBtn').addEventListener('click', cancelZoneEdit);

    // Управление пользователями
    document.getElementById('addUserBtn').addEventListener('click', () => {
      const name = document.getElementById('userName').value;
      const login = document.getElementById('userLogin').value;
      const password = document.getElementById('userPassword').value;
      const position = document.getElementById('userPosition').value;
      
      if (!name || !login || !password) {
        alert('Заполните все обязательные поля');
        return;
      }
      
      if (appData.users.some(u => u.login === login)) {
        alert('Пользователь с таким логином уже существует');
        return;
      }
      
      const newUser = {
        id: `u${Date.now()}`,
        name,
        login,
        password,
        position,
        lastLogin: new Date().toISOString()
      };
      
      appData.users.push(newUser);
      saveData();
      updateUsersList();
      
      document.getElementById('userName').value = '';
      document.getElementById('userLogin').value = '';
      document.getElementById('userPassword').value = '';
      document.getElementById('userPosition').value = 'scout';
    });

    document.getElementById('updateUserBtn').addEventListener('click', () => {
      const id = document.getElementById('updateUserBtn').dataset.editId;
      const name = document.getElementById('userName').value;
      const login = document.getElementById('userLogin').value;
      const password = document.getElementById('userPassword').value;
      const position = document.getElementById('userPosition').value;
      
      if (!name || !login) {
        alert('Заполните имя и логин');
        return;
      }
      
      // Проверяем, не занят ли логин другим пользователем
      const existingUser = appData.users.find(u => u.login === login && u.id !== id);
      if (existingUser) {
        alert('Пользователь с таким логином уже существует');
        return;
      }
      
      const user = appData.users.find(u => u.id === id);
      if (user) {
        user.name = name;
        user.login = login;
        user.position = position;
        
        // Обновляем пароль только если он был изменен
        if (password) {
          user.password = password;
        }
        
        saveData();
        updateUsersList();
        cancelUserEdit();
        
        // Если редактируем текущего пользователя, обновляем информацию
        if (currentUser && currentUser.id === id) {
          currentUser = user;
          document.getElementById('currentUser').textContent = user.name;
          showUserInfo();
        }
      }
    });

    document.getElementById('cancelUserEditBtn').addEventListener('click', cancelUserEdit);

    // Управление заданиями
    document.getElementById('addTaskBtn').addEventListener('click', () => {
      const name = document.getElementById('taskName').value;
      const type = document.getElementById('taskType').value;
      const assignee = document.getElementById('taskAssignee').value;
      const dueDate = document.getElementById('taskDueDate').value;
      const description = document.getElementById('taskDescription').value;
      const zone = document.getElementById('taskZone').value;
      
      if (!name || !dueDate || !zone) {
        alert('Заполните название, срок выполнения и зону');
        return;
      }
      
      const newTask = {
        id: `t${Date.now()}`,
        name,
        type,
        assignee,
        dueDate: new Date(dueDate).toISOString(),
        description,
        zone,
        status: 'pending'
      };
      
      appData.tasks.push(newTask);
      saveData();
      updateTasksList();
      renderZones();
      
      document.getElementById('taskName').value = '';
      document.getElementById('taskType').value = 'cleaning';
      document.getElementById('taskAssignee').value = '';
      document.getElementById('taskDueDate').value = '';
      document.getElementById('taskDescription').value = '';
      document.getElementById('taskZone').value = '';
    });

    document.getElementById('updateTaskBtn').addEventListener('click', () => {
      const id = document.getElementById('updateTaskBtn').dataset.editId;
      const name = document.getElementById('taskName').value;
      const type = document.getElementById('taskType').value;
      const assignee = document.getElementById('taskAssignee').value;
      const dueDate = document.getElementById('taskDueDate').value;
      const description = document.getElementById('taskDescription').value;
      const zone = document.getElementById('taskZone').value;
      
      if (!name || !dueDate || !zone) {
        alert('Заполните название, срок выполнения и зону');
        return;
      }
      
      const task = appData.tasks.find(t => t.id === id);
      if (task) {
        task.name = name;
        task.type = type;
        task.assignee = assignee;
        task.dueDate = new Date(dueDate).toISOString();
        task.description = description;
        task.zone = zone;
        
        saveData();
        updateTasksList();
        renderZones();
        cancelTaskEdit();
      }
    });

    document.getElementById('cancelTaskEditBtn').addEventListener('click', cancelTaskEdit);

    // Просмотр заданий пользователем
    document.getElementById('userTasksBtn').addEventListener('click', () => {
      if (currentUser && currentUser.position === 'admin') {
        openAdminModal();
        document.getElementById('adminTasksTab').click();
      } else {
        alert('Ваши задания будут отображены здесь');
      }
    });

    // Инициализация приложения
    function initApp() {
      renderZones();
      hideDrawToolbar();
      
      // Проверяем, есть ли текущий пользователь в localStorage
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        const user = JSON.parse(savedUser);
        const validUser = appData.users.find(u => u.id === user.id && u.login === user.login);
        if (validUser) {
          currentUser = validUser;
          document.getElementById('userStatus').classList.remove('hidden');
          document.getElementById('currentUser').textContent = validUser.name;
          document.getElementById('userLoginBtn').innerHTML = `
            <i class="fas fa-user"></i>
            <span>Профиль</span>
          `;
          
          if (validUser.position === 'admin') {
            document.getElementById('openAdminPanel').classList.remove('hidden');
          }
        }
      }
    }

    // Запуск приложения
    initApp();
  </script>
</body>
</html>