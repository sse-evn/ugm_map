<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Карта Алматы для скаутов</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <!-- Leaflet.Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <!-- Tailwind CSS через CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; overflow: hidden; }
    #map { height: calc(100vh - 3rem); width: 100%; }
    .zone-btn { 
      font-size: 0.75rem; /* Маленький шрифт для кнопок */
      padding: 0.25rem 0.5rem; 
      border-radius: 0.375rem; 
      transition: background-color 0.3s; 
      white-space: nowrap; /* Предотвращаем перенос текста */
    }
    .zone-btn.active { background-color: #1e40af; color: white; }
    #adminPanel { 
      display: none; 
      max-height: 100vh; 
      overflow-y: auto; 
      z-index: 1000; /* Выше карты */
    }
    .admin-form input, .admin-form select, .admin-form textarea { 
      font-size: 0.75rem; 
      padding: 0.25rem; 
      max-width: 100%; 
      overflow-wrap: break-word; /* Текст не выходит за границы */
    }
    .admin-form button { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
    .zone-list li { font-size: 0.7rem; padding: 0.25rem 0; }
    .zone-list button { font-size: 0.7rem; padding: 0.2rem 0.4rem; }
    /* Убедимся, что элементы не перекрываются */
    .fixed { z-index: 10; }
    #map { z-index: 1; }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Панель управления -->
  <div class="fixed top-0 w-full bg-white shadow-md p-1 z-10">
    <div class="flex justify-around gap-1 flex-wrap">
      <button id="workZone" class="zone-btn bg-blue-100 text-blue-800 font-semibold">Рабочие зоны</button>
      <button id="restZone" class="zone-btn bg-green-100 text-green-800 font-semibold">Зоны отдыха</button>
      <button id="officeZone" class="zone-btn bg-yellow-100 text-yellow-800 font-semibold">Офисы</button>
      <button id="adminLogin" class="zone-btn bg-red-100 text-red-800 font-semibold">Админ</button>
    </div>
  </div>

  <!-- Контейнер для карты -->
  <div id="map" class="mt-12"></div>

  <!-- Панель администратора -->
  <div id="adminPanel" class="fixed inset-0 bg-white p-2">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-sm font-bold">Панель администратора</h2>
      <button id="closeAdmin" class="text-red-500 text-xs">Закрыть</button>
    </div>
    <!-- Форма входа -->
    <div id="loginForm" class="mt-2">
      <input id="adminPassword" type="password" placeholder="Пароль" class="w-full p-1 border rounded-md text-xs">
      <button id="submitPassword" class="w-full mt-1 bg-blue-500 text-white p-1 rounded-md text-xs">Войти</button>
    </div>
    <!-- Форма управления зонами -->
    <div id="adminControls" class="admin-form hidden mt-2">
      <h3 class="text-xs font-semibold">Добавить/Редактировать зону</h3>
      <select id="zoneType" class="w-full p-1 border rounded-md text-xs">
        <option value="work">Рабочая зона</option>
        <option value="rest">Зона отдыха</option>
        <option value="office">Офис</option>
      </select>
      <input id="zoneName" type="text" placeholder="Название зоны" class="w-full p-1 mt-1 border rounded-md text-xs">
      <textarea id="zoneCoords" placeholder="Координаты (JSON, например, [[43.25, 76.85], ...])" class="w-full p-1 mt-1 border rounded-md text-xs" rows="3"></textarea>
      <button id="addZone" class="w-full mt-1 bg-green-500 text-white p-1 rounded-md text-xs">Добавить/Обновить</button>
      <h3 class="text-xs font-semibold mt-2">Существующие зоны</h3>
      <ul id="zoneList" class="mt-1"></ul>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- Leaflet.Draw JS -->
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    // Инициализация карты (центр Алматы)
    const map = L.map('map', {
      zoomControl: true,
      doubleClickZoom: false,
      maxZoom: 18,
      minZoom: 10
    }).setView([43.2389, 76.8897], 12);

    // Добавление тайлов OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18
    }).addTo(map);

    // Слои для зон
    let workLayer = L.layerGroup().addTo(map);
    let restLayer = L.layerGroup().addTo(map);
    let officeLayer = L.layerGroup().addTo(map);
    let drawnItems = new L.FeatureGroup().addTo(map);

    // Загрузка зон из localStorage
    let zones = JSON.parse(localStorage.getItem('zones')) || {
      work: [
        { id: 'w1', coords: [[43.25, 76.85], [43.25, 76.90], [43.30, 76.90], [43.30, 76.85]], popup: 'Рабочая зона: Центр' },
        { id: 'w2', coords: [[43.22, 76.92], [43.22, 76.97], [43.27, 76.97], [43.27, 76.92]], popup: 'Рабочая зона: Магазины' }
      ],
      rest: [
        { id: 'r1', coords: [[43.23, 76.88], [43.23, 76.93], [43.28, 76.93], [43.28, 76.88]], popup: 'Зона отдыха: Парк' }
      ],
      office: [
        { id: 'o1', coords: [43.238, 76.89], popup: 'Офис компании' }
      ]
    };

    // Leaflet.Draw для рисования зон
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { polyline: false, circle: false, marker: true, polygon: true, rectangle: true }
    });

    // Показываем Draw Control только для админа
    let isAdmin = false;
    function toggleDrawControl(show) {
      if (show) {
        map.addControl(drawControl);
      } else {
        map.removeControl(drawControl);
      }
    }

    // Обработка созданных объектов
    map.on(L.Draw.Event.CREATED, (e) => {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      const type = document.getElementById('zoneType').value;
      const name = prompt('Введите название зоны', 'Новая зона') || 'Новая зона';
      const id = `${type}_${Date.now()}`;
      let coords;
      if (e.layerType === 'marker') {
        coords = [layer.getLatLng().lat, layer.getLatLng().lng];
      } else {
        coords = layer.getLatLngs()[0].map(l => [l.lat, l.lng]);
      }
      zones[type].push({ id, coords, popup: name });
      saveZones();
      addZones();
      updateZoneList();
    });

    // Функция для отображения зон
    function addZones() {
      workLayer.clearLayers();
      restLayer.clearLayers();
      officeLayer.clearLayers();

      zones.work.forEach(zone => {
        L.polygon(zone.coords, { color: 'blue', fillOpacity: 0.3 })
          .addTo(workLayer)
          .bindPopup(zone.popup);
      });

      zones.rest.forEach(zone => {
        L.polygon(zone.coords, { color: 'green', fillOpacity: 0.3 })
          .addTo(restLayer)
          .bindPopup(zone.popup);
      });

      zones.office.forEach(zone => {
        L.marker(zone.coords, {
          icon: L.divIcon({ className: 'bg-yellow-500 rounded-full w-3 h-3' })
        }).addTo(officeLayer).bindPopup(zone.popup);
      });
    }

    // Загрузка данных из Overpass API (кафе)
    async function loadCafes() {
      const query = `
        [out:json];
        area[name="Almaty"]->.almaty;
        node["amenity"="cafe"](area.almaty);
        out body;
      `;
      try {
        const response = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: `data=${encodeURIComponent(query)}`
        });
        const data = await response.json();
        data.elements.forEach(element => {
          if (element.type === 'node') {
            L.marker([element.lat, element.lon], {
              icon: L.divIcon({ className: 'bg-red-500 rounded-full w-2 h-2' })
            }).addTo(restLayer).bindPopup(element.tags.name || 'Кафе');
          }
        });
      } catch (error) {
        console.error('Ошибка загрузки кафе:', error);
      }
    }

    // Сохранение зон в localStorage
    function saveZones() {
      localStorage.setItem('zones', JSON.stringify(zones));
    }

    // Обновление списка зон в админ-панели
    function updateZoneList() {
      const zoneList = document.getElementById('zoneList');
      zoneList.innerHTML = '';
      Object.keys(zones).forEach(type => {
        zones[type].forEach(zone => {
          const li = document.createElement('li');
          li.className = 'flex justify-between items-center border-b';
          li.innerHTML = `
            <span class="truncate max-w-[60%] text-xs">${zone.popup} (${type})</span>
            <div class="flex gap-1">
              <button class="edit-zone text-blue-500" data-id="${zone.id}" data-type="${type}">Ред.</button>
              <button class="delete-zone text-red-500" data-id="${zone.id}" data-type="${type}">Уд.</button>
            </div>
          `;
          zoneList.appendChild(li);
        });
      });

      document.querySelectorAll('.edit-zone').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const type = btn.dataset.type;
          const zone = zones[type].find(z => z.id === id);
          document.getElementById('zoneType').value = type;
          document.getElementById('zoneName').value = zone.popup;
          document.getElementById('zoneCoords').value = JSON.stringify(zone.coords);
          document.getElementById('addZone').dataset.editId = id;
          document.getElementById('addZone').dataset.editType = type;
        });
      });

      document.querySelectorAll('.delete-zone').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const type = btn.dataset.type;
          zones[type] = zones[type].filter(z => z.id !== id);
          saveZones();
          addZones();
          updateZoneList();
        });
      });
    }

    // Управление видимостью зон
    document.getElementById('workZone').addEventListener('click', () => toggleLayer(workLayer, 'workZone'));
    document.getElementById('restZone').addEventListener('click', () => toggleLayer(restLayer, 'restZone'));
    document.getElementById('officeZone').addEventListener('click', () => toggleLayer(officeLayer, 'officeZone'));

    function toggleLayer(layer, buttonId) {
      if (map.hasLayer(layer)) {
        map.removeLayer(layer);
        document.getElementById(buttonId).classList.remove('active');
      } else {
        map.addLayer(layer);
        document.getElementById(buttonId).classList.add('active');
      }
    }

    // Управление админ-панелью
    const adminPanel = document.getElementById('adminPanel');
    const loginForm = document.getElementById('loginForm');
    const adminControls = document.getElementById('adminControls');
    const adminPassword = document.getElementById('adminPassword');
    const submitPassword = document.getElementById('submitPassword');
    const closeAdmin = document.getElementById('closeAdmin');
    const addZone = document.getElementById('addZone');

    document.getElementById('adminLogin').addEventListener('click', () => {
      adminPanel.style.display = 'block';
      loginForm.style.display = 'block';
      adminControls.style.display = 'none';
    });

    submitPassword.addEventListener('click', () => {
      if (adminPassword.value === 'root') {
        loginForm.style.display = 'none';
        adminControls.style.display = 'block';
        isAdmin = true;
        toggleDrawControl(true);
        updateZoneList();
      } else {
        alert('Неверный пароль');
      }
    });

    closeAdmin.addEventListener('click', () => {
      adminPanel.style.display = 'none';
      adminPassword.value = '';
      isAdmin = false;
      toggleDrawControl(false);
    });

    addZone.addEventListener('click', () => {
      const type = document.getElementById('zoneType').value;
      const name = document.getElementById('zoneName').value;
      let coords;
      try {
        coords = JSON.parse(document.getElementById('zoneCoords').value || '[]');
      } catch (e) {
        alert('Неверный формат координат (используйте JSON)');
        return;
      }
      const id = addZone.dataset.editId || `${type}_${Date.now()}`;
      if (name && coords.length) {
        if (addZone.dataset.editId) {
          const oldType = addZone.dataset.editType;
          zones[oldType] = zones[oldType].filter(z => z.id !== id);
          delete addZone.dataset.editId;
          delete addZone.dataset.editType;
        }
        zones[type].push({ id, coords, popup: name });
        saveZones();
        addZones();
        updateZoneList();
        document.getElementById('zoneName').value = '';
        document.getElementById('zoneCoords').value = '';
      } else {
        alert('Заполните название и координаты');
      }
    });

    // Инициализация
    addZones();
    loadCafes();
    toggleDrawControl(false); // Draw Control скрыт по умолчанию
  </script>
</body>

</html>